<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fitness & Lift Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .tab-btn { transition: all 0.2s; }
        .tab-btn.active { border-color: #3b82f6; color: #3b82f6; font-weight: 700; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); z-index: 10; }
        #global-notification {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            min-width: 280px;
        }
        .video-container { position: relative; width: 100%; height: 300px; overflow: hidden; border-radius: 0.5rem; background-color: #1f2937; }
        #camera-video { width: 100%; height: 100%; object-fit: cover; }
        #camera-canvas { display: none; } /* Hidden canvas used for image capture */
        #captured-image-container { margin-top: 1rem; }
    </style>
    
    <!-- FIREBASE CDN LINKS ADDED HERE (Before your custom script) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- YOUR CONFIGURATION START ---
        // 1. YOUR FIREBASE CONFIGURATION OBJECT IS PLACED HERE
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDSxX65VwZSWTu0yJEAQpH_INGopzOqHMQ",
            authDomain: "fitness-tracker-f1ee0.firebaseapp.com",
            databaseURL: "https://fitness-tracker-f1ee0-default-rtdb.firebaseio.com",
            projectId: "fitness-tracker-f1ee0",
            storageBucket: "fitness-tracker-f1ee0.firebasestorage.app",
            messagingSenderId: "828412836387",
            appId: "1:828412836387:web:392399d1b9dd125d77cf96"
        };

        // 2. PASTE YOUR GEMINI API KEY HERE (If running outside of Canvas)
        const GEMINI_API_KEY = "AIzaSyBY-65HRqEXcoymmO1LRtEnaxMMAZGOalQ"; // !!! REPLACE "" WITH YOUR ACTUAL GEMINI API KEY for AI features to work. !!!

        // --- YOUR CONFIGURATION END ---
        
        // DO NOT EDIT BELOW THIS LINE
        const firebaseConfig = YOUR_FIREBASE_CONFIG;
        const appId = firebaseConfig.projectId;
        const API_KEY = GEMINI_API_KEY; 
        
        let app, db, auth, userId = null;
        let cameraStream = null; // Global variable to hold the camera stream

        // Global State
        let state = {
            currentDate: new Date().toISOString().substring(0, 10), // YYYY-MM-DD
            goals: { calorieGoal: 0, proteinGoal: 0 },
            foodLogs: [],
            liftLogs: [],
            isAuthReady: false,
            capturedImageData: null, // Stores Base64 image data for AI analysis
        };

        // --- Utility Functions ---

        /** Converts Date object to YYYY-MM-DD string */
        const toYYYYMMDD = (date) => date.toISOString().substring(0, 10);

        /** Calculates the start of the week (Monday) for a given date */
        const getStartOfWeek = (dateString) => {
            const date = new Date(dateString);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday being 0, starts Monday (1)
            const startOfWeek = new Date(date.setDate(diff));
            return toYYYYMMDD(startOfWeek);
        };

        /** Calculates the end of the week (Sunday) for a given date */
        const getEndOfWeek = (dateString) => {
            const date = new Date(dateString);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? 0 : 7); // Adjust for Sunday being 0, ends Sunday (0)
            const endOfWeek = new Date(date.setDate(diff));
            return toYYYYMMDD(endOfWeek);
        };

        /** Extracts YYYY-MM from YYYY-MM-DD */
        const toYYYYMM = (dateString) => dateString.substring(0, 7);

        /** Shows the loading spinner */
        const showLoading = (show) => {
            document.getElementById('loading').classList.toggle('hidden', !show);
        };

        /** Displays temporary message for goals tab (local element) */
        const showMessage = (elementId, message, isError = false) => {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden', 'text-green-600', 'text-red-600');
            el.classList.add(isError ? 'text-red-600' : 'text-green-600');
            setTimeout(() => el.classList.add('hidden'), 3000);
        };
        
        /** Displays temporary floating global notification (replaces alert()) */
        const showGlobalNotification = (message, isError = false) => {
            const el = document.getElementById('global-notification');
            el.textContent = message;

            // Apply color based on type
            el.classList.remove('bg-red-600', 'bg-green-600', 'bg-blue-600');
            if (isError) {
                el.classList.add('bg-red-600');
            } else if (message.toLowerCase().includes('success') || message.toLowerCase().includes('logged') || message.toLowerCase().includes('recorded')) {
                el.classList.add('bg-green-600');
            } else {
                el.classList.add('bg-blue-600');
            }

            // Show animation
            el.classList.remove('translate-y-full', 'opacity-0');
            el.classList.add('translate-y-0', 'opacity-100');

            // Hide animation
            setTimeout(() => {
                el.classList.remove('translate-y-0', 'opacity-100');
                el.classList.add('translate-y-full', 'opacity-0');
            }, 4000);
        };

        // --- Firebase Initialization and Auth ---

        async function initFirebase() {
            try {
                // Check if user has replaced the config placeholders
                if (!firebaseConfig.projectId || firebaseConfig.projectId.includes("YOUR")) {
                    console.error("Firebase config is missing or incomplete. Using mock data.");
                    // Fallback to mock data if the user hasn't set up the config
                    app = { name: 'mock-app' };
                    auth = { currentUser: { uid: 'mock-user-' + crypto.randomUUID() } };
                    userId = auth.currentUser.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    state.isAuthReady = true;
                    loadMockData();
                    return;
                }
                
                // CHECK FOR MISSING GEMINI API KEY (DIAGNOSTIC)
                if (API_KEY === "") {
                     console.warn("Warning: Gemini API key is missing. AI Search/Scan will not work.");
                     showGlobalNotification("Warning: Gemini API key is missing. AI features disabled.", true);
                }


                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Use standard Anonymous Sign-In for self-hosted apps
                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                    } 
                    state.isAuthReady = true;
                    if (userId) {
                        setupRealtimeListeners();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                document.getElementById('userIdDisplay').textContent = "Auth Error";
                showGlobalNotification("Error: Failed to initialize Firebase. Check your config and services.", true);
            }
        }

        // --- Firestore Paths ---

        const getPath = (collectionName) => {
            if (!userId) {
                console.error("User ID not available for Firestore operations.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/{your_collection_name}
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        };

        const getGoalDocRef = () => {
            const path = getPath('goals');
            return path ? doc(db, path, 'userGoals') : null;
        };

        const getFoodCollectionRef = () => {
            const path = getPath('foodLogs');
            return path ? collection(db, path) : null;
        };

        const getLiftCollectionRef = () => {
            const path = getPath('liftLogs');
            return path ? collection(db, path) : null;
        };

        // --- Realtime Data Listeners ---

        function setupRealtimeListeners() {
            if (!db || !userId) return;

            // 1. Listen to Goals
            const goalRef = getGoalDocRef();
            if (goalRef) {
                onSnapshot(goalRef, (docSnap) => {
                    if (docSnap.exists()) {
                        state.goals = docSnap.data();
                    } else {
                        state.goals = { calorieGoal: 0, proteinGoal: 0 };
                    }
                    renderTrackerTab();
                }, (error) => console.error("Error fetching goals:", error));
            }

            // 2. Listen to All Food Logs
            const foodCollectionRef = getFoodCollectionRef();
            if (foodCollectionRef) {
                const foodQuery = query(foodCollectionRef);
                onSnapshot(foodQuery, (snapshot) => {
                    state.foodLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Re-render tabs that depend on food/macro data
                    renderTrackerTab();
                    renderLiftsTab();
                }, (error) => console.error("Error fetching food logs:", error));
            }

            // 3. Listen to All Lift Logs
            const liftCollectionRef = getLiftCollectionRef();
            if (liftCollectionRef) {
                const liftQuery = query(liftCollectionRef);
                onSnapshot(liftQuery, (snapshot) => {
                    state.liftLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Re-render tabs that depend on lift data
                    renderTrackerTab();
                    renderLiftsTab();
                }, (error) => console.error("Error fetching lift logs:", error));
            }
        }


        // --- Goal Management ---

        window.saveGoals = async () => {
            if (!db || !userId) {
                showMessage('goal-save-message', "Authentication not ready. Try again.", true);
                return;
            }

            const calorieGoal = parseInt(document.getElementById('goal-cal').value) || 0;
            const proteinGoal = parseInt(document.getElementById('goal-prot').value) || 0;

            const goals = {
                calorieGoal: Math.max(0, calorieGoal),
                proteinGoal: Math.max(0, proteinGoal),
            };

            const goalRef = getGoalDocRef();
            if (goalRef) {
                try {
                    await setDoc(goalRef, goals, { merge: true });
                    showMessage('goal-save-message', 'Goals saved successfully!');
                    state.goals = goals; // Optimistically update state
                    renderTrackerTab();
                } catch (e) {
                    console.error("Error saving goals: ", e);
                    showMessage('goal-save-message', 'Error saving goals.', true);
                }
            }
        };

        // --- AI API Call for Macro Counting ---

        /** Calls the Gemini API to get structured macro data from a food description and optional image*/
        async function getMacrosFromAI(description, imageBase64) {
            
            if (API_KEY === "") {
                 throw new Error("Gemini API key is required for AI features. Please add it to the script.");
            }

            const systemPrompt = "You are a food and nutrition estimator. Given a food description and optional image, you must return the estimated nutritional content for that item in grams and calories. Be realistic. The response must ONLY be a JSON object conforming to the schema.";
            
            const contents = [
                {
                    role: "user",
                    parts: [
                        { text: `Estimate macros for: "${description}"` }
                    ]
                }
            ];

            if (imageBase64) {
                const mimeType = imageBase64.substring(5, imageBase64.indexOf(';'));
                const base64Data = imageBase64.split(',')[1];
                contents[0].parts.unshift({ // Add image data to the start of the parts array
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Data
                    }
                });
            }

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "name": { "type": "STRING", "description": "A concise name for the food item, e.g., 'Avocado Toast with Egg'." },
                            "calories": { "type": "NUMBER", "description": "Total estimated calories (kcal)." },
                            "protein": { "type": "NUMBER", "description": "Protein in grams (g)." },
                            "carbs": { "type": "NUMBER", "description": "Carbohydrates in grams (g)." },
                            "fat": { "type": "NUMBER", "description": "Fat in grams (g)." }
                        },
                        required: ["name", "calories", "protein", "carbs", "fat"]
                    }
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            
            showLoading(true);

            try {
                let response;
                let parsedJson;
                const maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            try {
                                parsedJson = JSON.parse(text);
                                showLoading(false);
                                return parsedJson;
                            } catch (e) {
                                console.error("Failed to parse JSON response:", e, "Raw text:", text);
                            }
                        }
                    }

                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
                throw new Error("API call failed or returned invalid data after multiple retries.");

            } catch (error) {
                showLoading(false);
                console.error("Error during AI fetch:", error);
                throw new Error("Could not get nutrition data from AI. Please try manual entry.");
            }
        }


        // --- Food Logging ---

        window.logFood = async (source) => {
            if (!db || !userId) {
                showGlobalNotification("Authentication not complete. Please wait.", true);
                return;
            }

            let foodData = {};
            let imageBase64 = null;

            if (source === 'manual') {
                const name = document.getElementById('manual-name').value;
                const calories = parseInt(document.getElementById('manual-calories').value) || 0;
                const protein = parseInt(document.getElementById('manual-protein').value) || 0;
                const carbs = parseInt(document.getElementById('manual-carbs').value) || 0;
                const fat = parseInt(document.getElementById('manual-fat').value) || 0;

                if (!name || calories + protein + carbs + fat === 0) {
                    showGlobalNotification("Input Error: Please fill in food name and at least one macro/calorie field.", true);
                    return;
                }
                foodData = { name: name + " (Manual)", calories, protein, carbs, fat };

            } else if (source === 'ai-search' || source === 'camera-scan') {
                const description = source === 'ai-search'
                    ? document.getElementById('ai-food-description').value
                    : document.getElementById('camera-scan-description').value;
                
                if (source === 'camera-scan') {
                    imageBase64 = state.capturedImageData;
                    if (!imageBase64) {
                        showGlobalNotification("Input Error: Please capture an image first.", true);
                        return;
                    }
                }

                if (!description && !imageBase64) {
                    showGlobalNotification("Input Error: Please provide a description for AI analysis.", true);
                    return;
                }
                
                try {
                    // PREVENT AI CALL IF KEY IS MISSING (Checked inside getMacrosFromAI)
                    const aiResult = await getMacrosFromAI(description, imageBase64);
                    foodData = {
                        name: aiResult.name + (source === 'ai-search' ? ' (AI Search)' : ' (AI Scan)'),
                        calories: aiResult.calories,
                        protein: aiResult.protein,
                        carbs: aiResult.carbs,
                        fat: aiResult.fat
                    };
                } catch (error) {
                    showGlobalNotification(error.message, true);
                    return;
                }
            }

            const logEntry = {
                ...foodData,
                date: state.currentDate,
                timestamp: serverTimestamp(),
            };

            const foodCollectionRef = getFoodCollectionRef();
            if (foodCollectionRef) {
                try {
                    await addDoc(foodCollectionRef, logEntry);
                    showGlobalNotification(`${foodData.name} logged successfully!`);
                    // Clear inputs
                    if (source === 'manual') {
                        document.getElementById('manual-name').value = '';
                        document.getElementById('manual-calories').value = '';
                        document.getElementById('manual-protein').value = '';
                        document.getElementById('manual-carbs').value = '';
                        document.getElementById('manual-fat').value = '';
                    } else if (source === 'ai-search') {
                        document.getElementById('ai-food-description').value = '';
                    } else if (source === 'camera-scan') {
                        document.getElementById('camera-scan-description').value = '';
                        document.getElementById('captured-image-container').innerHTML = '';
                        state.capturedImageData = null;
                    }
                } catch (e) {
                    console.error("Error adding food log: ", e);
                    showGlobalNotification("Error saving food log. Check console.", true);
                }
            }
        };

        // --- Camera Functions ---

        /** Initializes camera stream when the camera tab is selected */
        async function startCamera() {
            const video = document.getElementById('camera-video');
            if (cameraStream) return; // Already started

            try {
                // Request access to the user's camera
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = cameraStream;
                await video.play();
                showGlobalNotification("Camera feed started. Capture your meal!");
            } catch (err) {
                console.error("Error accessing camera:", err);
                showGlobalNotification("Error: Could not access camera. Check permissions.", true);
            }
        }

        /** Stops the camera stream when the tab is switched away */
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('camera-video').srcObject = null;
        }

        /** Captures a frame from the video stream */
        window.captureImage = () => {
            if (!cameraStream) {
                showGlobalNotification("Camera not active. Please start the camera first.", true);
                return;
            }

            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');

            // Set canvas dimensions to match the video feed
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw the current video frame onto the canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Get the image data in Base64 format
            const imageDataURL = canvas.toDataURL('image/jpeg', 0.8); // 80% quality

            state.capturedImageData = imageDataURL;

            // Display the captured image
            const container = document.getElementById('captured-image-container');
            container.innerHTML = `<img src="${imageDataURL}" class="rounded-lg shadow-md w-full max-h-64 object-cover" alt="Captured Food Image">`;

            showGlobalNotification("Image captured successfully. Add description and analyze.");
        };

        // --- Lift Logging ---

        window.logLift = async () => {
            if (!db || !userId) {
                showGlobalNotification("Authentication not complete. Please wait.", true);
                return;
            }

            const exercise = document.getElementById('lift-exercise').value.trim();
            const weight = parseFloat(document.getElementById('lift-weight').value) || 0;
            const reps = parseInt(document.getElementById('lift-reps').value) || 0;
            const isMainLift = document.getElementById('lift-main').checked;

            if (!exercise || weight === 0 || reps === 0) {
                showGlobalNotification("Input Error: Please fill in the exercise, weight, and reps.", true);
                return;
            }

            const liftEntry = {
                date: state.currentDate,
                exercise,
                weight,
                reps,
                isMainLift,
                timestamp: serverTimestamp(),
            };

            const liftCollectionRef = getLiftCollectionRef();
            if (liftCollectionRef) {
                try {
                    await addDoc(liftCollectionRef, liftEntry);
                    showGlobalNotification(`${exercise} recorded successfully!`);
                    // Clear inputs
                    document.getElementById('lift-exercise').value = '';
                    document.getElementById('lift-weight').value = '';
                    document.getElementById('lift-reps').value = '';
                    document.getElementById('lift-main').checked = false;
                } catch (e) {
                    console.error("Error adding lift log: ", e);
                    showGlobalNotification("Error saving lift log. Check console.", true);
                }
            }
        };

        // --- Render Functions ---

        function renderTrackerTab() {
            // 1. Update Date Display
            document.getElementById('log-date-display').textContent = state.currentDate;
            document.getElementById('date-picker').value = state.currentDate;

            // 2. Update Goals Summary
            const { calorieGoal, proteinGoal } = state.goals;
            document.getElementById('goal-calories').textContent = calorieGoal || 'N/A';
            document.getElementById('goal-protein').textContent = proteinGoal || 'N/A';

            // 3. Filter Logs for Current Date
            const dailyFoodLogs = state.foodLogs.filter(log => log.date === state.currentDate);

            // 4. Calculate Daily Macros
            const dailyTotals = dailyFoodLogs.reduce((acc, log) => {
                acc.calories += log.calories || 0;
                acc.protein += log.protein || 0;
                acc.carbs += log.carbs || 0;
                acc.fat += log.fat || 0;
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

            // 5. Update Daily Summary
            document.getElementById('total-calories').textContent = Math.round(dailyTotals.calories);
            document.getElementById('total-protein').textContent = Math.round(dailyTotals.protein);
            document.getElementById('total-carbs').textContent = Math.round(dailyTotals.carbs);
            document.getElementById('total-fat').textContent = Math.round(dailyTotals.fat);

            // 6. Update Protein Remaining
            const proteinRemaining = Math.max(0, (proteinGoal || 0) - dailyTotals.protein);
            document.getElementById('protein-remaining').textContent = Math.round(proteinRemaining);
            document.getElementById('protein-remaining').classList.toggle('text-green-600', proteinRemaining > 0);
            document.getElementById('protein-remaining').classList.toggle('text-red-600', proteinRemaining <= 0 && proteinGoal > 0);


            // 7. Render Food Log List
            const logListEl = document.getElementById('food-log-list');
            logListEl.innerHTML = ''; // Clear existing
            if (dailyFoodLogs.length === 0) {
                logListEl.innerHTML = '<p class="text-gray-500 italic">No food entries for this date.</p>';
                return;
            }

            dailyFoodLogs.forEach(log => {
                const item = document.createElement('div');
                item.className = 'bg-gray-50 p-3 rounded-lg flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${log.name}</p>
                        <p class="text-xs text-gray-500">${Math.round(log.calories)} kcal | P: ${Math.round(log.protein)}g | C: ${Math.round(log.carbs)}g | F: ${Math.round(log.fat)}g</p>
                    </div>
                    <button onclick="deleteFoodLog('${log.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full bg-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                logListEl.appendChild(item);
            });
        }

        window.deleteFoodLog = async (id) => {
            if (!db || !userId) {
                showGlobalNotification("Authentication not complete. Cannot delete item.", true);
                return;
            }
            const foodCollectionRef = getFoodCollectionRef();
            if (foodCollectionRef) {
                const docRef = doc(foodCollectionRef, id);
                try {
                    await deleteDoc(docRef);
                    showGlobalNotification("Food entry deleted successfully.");
                } catch (e) {
                    console.error("Error deleting document:", e);
                    showGlobalNotification("Error deleting food entry. Check console.", true);
                }
            }
        };

        function renderLiftsTab() {
            const today = new Date(state.currentDate);
            const startOfWeek = getStartOfWeek(state.currentDate);
            const endOfWeek = getEndOfWeek(state.currentDate);

            document.getElementById('week-start').textContent = startOfWeek;
            document.getElementById('week-end').textContent = endOfWeek;

            // Filter for main lifts within the current week
            const weeklyMainLifts = state.liftLogs.filter(log =>
                log.isMainLift &&
                log.date >= startOfWeek &&
                log.date <= endOfWeek
            );

            // Group by exercise and find the max weight
            const maxLifts = weeklyMainLifts.reduce((acc, lift) => {
                const { exercise, weight, reps } = lift;
                const key = exercise.toLowerCase();
                if (!acc[key] || acc[key].weight < weight) {
                    acc[key] = { exercise, weight, reps, date: lift.date };
                }
                return acc;
            }, {});

            const summaryEl = document.getElementById('weekly-lifts-summary');
            summaryEl.innerHTML = '';

            const liftEntries = Object.values(maxLifts);
            if (liftEntries.length === 0) {
                summaryEl.innerHTML = '<p class="text-gray-500 italic">No main lifts recorded this week.</p>';
                return;
            }

            liftEntries.sort((a, b) => b.weight - a.weight).forEach(lift => {
                const item = document.createElement('div');
                item.className = 'bg-blue-50 p-4 rounded-lg flex justify-between items-center';
                item.innerHTML = `
                    <div class="font-semibold text-gray-800">${lift.exercise}</div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-blue-700">${lift.weight} kg/lb x ${lift.reps} reps</p>
                        <p class="text-xs text-gray-500">${lift.date}</p>
                    </div>
                `;
                summaryEl.appendChild(item);
            });
        }

        function renderGoalsTab() {
            document.getElementById('goal-cal').value = state.goals.calorieGoal || '';
            document.getElementById('goal-prot').value = state.goals.proteinGoal || '';
        }

        window.renderProgress = (view) => {
            const progressEl = document.getElementById('progress-content');
            progressEl.innerHTML = '';
            
            const logsByPeriod = {};
            const periods = {}; // Stores dates for sorting

            // Determine how to group data
            state.foodLogs.forEach(log => {
                let periodKey;
                if (view === 'weekly') {
                    periodKey = getStartOfWeek(log.date);
                    periods[periodKey] = periodKey; // Store start date
                } else if (view === 'monthly') {
                    periodKey = toYYYYMM(log.date);
                    periods[periodKey] = periodKey; // Store YYYY-MM
                }
                logsByPeriod[periodKey] = logsByPeriod[periodKey] || { calories: 0, protein: 0, mainLifts: {} };
                logsByPeriod[periodKey].calories += log.calories || 0;
                logsByPeriod[periodKey].protein += log.protein || 0;
            });

            state.liftLogs.filter(log => log.isMainLift).forEach(log => {
                let periodKey;
                if (view === 'weekly') {
                    periodKey = getStartOfWeek(log.date);
                } else if (view === 'monthly') {
                    periodKey = toYYYYMM(log.date);
                }
                logsByPeriod[periodKey] = logsByPeriod[periodKey] || { calories: 0, protein: 0, mainLifts: {} };

                const key = log.exercise.toLowerCase();
                logsByPeriod[periodKey].mainLifts[key] = logsByPeriod[periodKey].mainLifts[key] || { exercise: log.exercise, maxWeight: 0, date: log.date };
                if (logsByPeriod[periodKey].mainLifts[key].maxWeight < log.weight) {
                     logsByPeriod[periodKey].mainLifts[key].maxWeight = log.weight;
                     logsByPeriod[periodKey].mainLifts[key].date = log.date;
                }
            });

            const sortedPeriods = Object.keys(periods).sort().reverse(); // Sort descending by date

            if (sortedPeriods.length === 0) {
                 progressEl.innerHTML = '<p class="text-gray-500 italic text-center pt-8">No data available to show progress.</p>';
                 return;
            }

            sortedPeriods.forEach(periodKey => {
                const data = logsByPeriod[periodKey];
                const liftSummary = Object.values(data.mainLifts).map(l => `${l.exercise}: ${l.maxWeight} (Max)`).join(', ') || 'No main lifts recorded';

                const periodTitle = view === 'weekly' 
                    ? `Week Starting: ${periodKey}`
                    : `Month: ${periodKey}`;

                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-xl card mb-4';
                item.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${periodTitle}</h3>
                    <p class="text-sm text-gray-700"><strong>Total Calories:</strong> ${Math.round(data.calories)} kcal</p>
                    <p class="text-sm text-gray-700"><strong>Total Protein:</strong> ${Math.round(data.protein)} g</p>
                    <p class="text-sm text-gray-700 mt-2"><strong>Lift Highlights:</strong> ${liftSummary}</p>
                `;
                progressEl.appendChild(item);
            });

        };

        // --- Event Listeners and Setup ---

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();

            // Set up date picker listener
            const datePicker = document.getElementById('date-picker');
            datePicker.value = state.currentDate;
            datePicker.addEventListener('change', (e) => {
                state.currentDate = e.target.value;
                renderTrackerTab();
                renderLiftsTab(); // Renders weekly summary based on the selected day's week
            });

            // Set up tab switching
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.target.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                    document.getElementById(tabName).classList.remove('hidden');

                    // Conditional render on tab switch
                    if (tabName === 'tracker') {
                        renderTrackerTab();
                    } else if (tabName === 'lifts') {
                        renderLiftsTab();
                    } else if (tabName === 'goals') {
                        renderGoalsTab();
                    } else if (tabName === 'progress') {
                        // User needs to click a button to render progress
                    }
                    
                    // Always stop camera when switching away from the tracker tab
                    if (tabName !== 'tracker') {
                         stopCamera();
                    }
                });
            });

            // Set up food input tab switching
             document.querySelectorAll('.food-input-tab').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.target.getAttribute('data-input-tab');
                    
                    document.querySelectorAll('.food-input-tab').forEach(btn => {
                        btn.classList.remove('active', 'border-blue-600', 'font-semibold');
                        btn.classList.add('border-transparent');
                    });
                    e.target.classList.add('active', 'border-blue-600', 'font-semibold');
                    e.target.classList.remove('border-transparent');

                    document.querySelectorAll('.food-input-pane').forEach(pane => pane.classList.add('hidden'));
                    document.getElementById(tabName).classList.remove('hidden');
                    
                    if (tabName === 'camera-scan') {
                        startCamera();
                    } else {
                        stopCamera();
                    }
                });
            });

            // Initial render
            renderTrackerTab();
            renderGoalsTab();
        });

        // Mock data loading function (only used if Firebase is unavailable)
        function loadMockData() {
            state.goals = { calorieGoal: 2200, proteinGoal: 150 };
            state.foodLogs = [
                { id: 'f1', date: toYYYYMMDD(new Date()), name: 'Oatmeal (Manual)', calories: 300, protein: 10, carbs: 50, fat: 5 },
                { id: 'f2', date: toYYYYMMDD(new Date()), name: 'Chicken Salad (AI Scan Mock)', calories: 450, protein: 45, carbs: 10, fat: 20 },
            ];
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            const thisWeekStart = getStartOfWeek(state.currentDate);

            state.liftLogs = [
                { id: 'l1', date: thisWeekStart, exercise: 'Squat', weight: 140, reps: 5, isMainLift: true },
                { id: 'l2', date: thisWeekStart, exercise: 'Bench Press', weight: 90, reps: 5, isMainLift: true },
                { id: 'l3', date: toYYYYMMDD(new Date()), exercise: 'Squat', weight: 145, reps: 5, isMainLift: true }, // Progress
                { id: 'l4', date: toYYYYMMDD(lastWeek), exercise: 'Deadlift', weight: 160, reps: 5, isMainLift: true },
            ];
            renderTrackerTab();
            renderLiftsTab();
        }

    </script>
</head>
<body class="min-h-screen">

    <!-- Loading and API Key Placeholder -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center loading-overlay hidden">
        <div class="p-4 bg-white rounded-lg shadow-xl flex items-center space-x-3">
            <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700">Processing with AI...</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">AI Fitness Hub</h1>
            <p class="text-sm text-gray-500 mt-1">User ID: <span id="userIdDisplay" class="font-mono text-xs bg-gray-100 px-2 py-0.5 rounded">Loading...</span></p>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex border-b border-gray-200 mb-6 sticky top-0 bg-white z-50">
            <button class="tab-btn flex-1 p-3 text-gray-600 border-b-2 border-transparent active" data-tab="tracker">Tracker</button>
            <button class="tab-btn flex-1 p-3 text-gray-600 border-b-2 border-transparent" data-tab="lifts">Lifts</button>
            <button class="tab-btn flex-1 p-3 text-gray-600 border-b-2 border-transparent" data-tab="progress">Progress</button>
            <button class="tab-btn flex-1 p-3 text-gray-600 border-b-2 border-transparent" data-tab="goals">Goals</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Tracker Tab (Default) -->
            <div id="tracker" class="tab-pane">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <!-- Date Picker -->
                    <div class="card bg-white p-4 rounded-xl">
                        <label for="date-picker" class="block text-lg font-semibold text-gray-700 mb-2">Selected Day</label>
                        <input type="date" id="date-picker" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- Goal Summary -->
                    <div class="card bg-blue-50 p-4 rounded-xl">
                        <h2 class="text-xl font-bold text-blue-700 mb-2">Goals Overview</h2>
                        <div id="goal-summary" class="space-y-1 text-blue-600">
                            <p>Calories Goal: <span class="font-bold" id="goal-calories">--</span> kcal</p>
                            <p>Protein Goal: <span class="font-bold" id="goal-protein">--</span> g</p>
                            <p>Protein Remaining: <span class="font-bold text-green-600" id="protein-remaining">--</span> g</p>
                        </div>
                    </div>
                </div>

                <!-- Daily Macro Summary -->
                <div class="card bg-white p-6 rounded-xl mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily Summary</h2>
                    <div id="macro-progress" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-extrabold text-blue-600" id="total-calories">0</div>
                            <div class="text-sm text-gray-500">Calories</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-extrabold text-green-600" id="total-protein">0</div>
                            <div class="text-sm text-gray-500">Protein (g)</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-extrabold text-amber-600" id="total-carbs">0</div>
                            <div class="text-sm text-gray-500">Carbs (g)</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-extrabold text-red-600" id="total-fat">0</div>
                            <div class="text-sm text-gray-500">Fat (g)</div>
                        </div>
                    </div>
                </div>

                <!-- Food Input Section -->
                <div class="card bg-white p-6 rounded-xl mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Add Food</h2>

                    <!-- Input Tabs (AI Search, Manual, Camera Mock) -->
                    <div class="flex border-b border-gray-200 mb-4">
                        <button class="flex-1 p-2 text-sm text-gray-600 border-b-2 border-transparent food-input-tab active" data-input-tab="ai-search">AI Search</button>
                        <button class="flex-1 p-2 text-sm text-gray-600 border-b-2 border-transparent food-input-tab" data-input-tab="manual">Manual Entry</button>
                        <button class="flex-1 p-2 text-sm text-gray-600 border-b-2 border-transparent food-input-tab" data-input-tab="camera-scan">Camera Scan</button>
                    </div>

                    <!-- AI Search Tab Content -->
                    <div id="ai-search" class="food-input-pane">
                        <p class="text-sm text-gray-500 mb-3">Describe the food (e.g., "1 large avocado on toast with one egg"). AI will estimate macros.</p>
                        <textarea id="ai-food-description" rows="2" class="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-2"></textarea>
                        <button onclick="logFood('ai-search')" class="w-full bg-blue-600 text-white p-3 rounded-xl font-semibold hover:bg-blue-700">Analyze & Add Food</button>
                    </div>

                    <!-- Manual Entry Tab Content -->
                    <div id="manual" class="food-input-pane hidden">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="manual-name" placeholder="Food Name (e.g., Apple)" class="col-span-2 p-2 border rounded-lg">
                            <input type="number" id="manual-calories" placeholder="Calories (kcal)" class="p-2 border rounded-lg">
                            <input type="number" id="manual-protein" placeholder="Protein (g)" class="p-2 border rounded-lg">
                            <input type="number" id="manual-carbs" placeholder="Carbs (g)" class="p-2 border rounded-lg">
                            <input type="number" id="manual-fat" placeholder="Fat (g)" class="p-2 border rounded-lg">
                        </div>
                        <button onclick="logFood('manual')" class="w-full bg-blue-600 text-white p-3 rounded-xl font-semibold mt-4 hover:bg-blue-700">Manually Add Food</button>
                    </div>

                    <!-- Camera Scan Tab Content -->
                    <div id="camera-scan" class="food-input-pane hidden">
                        <p class="text-sm text-gray-500 mb-3">Take a photo of your meal and provide a description for AI analysis.</p>
                        
                        <!-- Video Feed and Canvas -->
                        <div class="video-container mb-4">
                            <video id="camera-video" autoplay playsinline class="rounded-lg"></video>
                            <canvas id="camera-canvas"></canvas>
                        </div>

                        <button onclick="captureImage()" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 mb-3">Capture Image</button>
                        
                        <div id="captured-image-container" class="mb-4">
                            <!-- Captured image will appear here -->
                        </div>

                        <textarea id="camera-scan-description" rows="2" class="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-2" placeholder="e.g., The portion size and ingredients of the plate in the photo."></textarea>
                        <button onclick="logFood('camera-scan')" class="w-full bg-blue-600 text-white p-3 rounded-xl font-semibold hover:bg-blue-700">Analyze & Add Food</button>
                    </div>

                </div>

                <!-- Daily Log Display -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Food Log for <span id="log-date-display">Today</span></h2>
                    <div id="food-log-list" class="space-y-3">
                        <p class="text-gray-500 italic" id="empty-food-log">No food entries for this date.</p>
                    </div>
                </div>

            </div>

            <!-- Lifts Tab -->
            <div id="lifts" class="tab-pane hidden">
                <!-- Daily Lift Input -->
                <div class="card bg-white p-6 rounded-xl mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Record Daily Lift</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="lift-exercise" placeholder="Exercise (e.g., Squat)" class="col-span-2 p-2 border rounded-lg">
                        <input type="number" id="lift-weight" placeholder="Weight (kg/lb)" class="p-2 border rounded-lg">
                        <input type="number" id="lift-reps" placeholder="Reps" class="p-2 border rounded-lg">
                        <div class="col-span-2 flex items-center">
                            <input type="checkbox" id="lift-main" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="lift-main" class="ml-2 text-sm text-gray-700">Is this a main lift for weekly progress?</label>
                        </div>
                    </div>
                    <button onclick="logLift()" class="w-full bg-green-600 text-white p-3 rounded-xl font-semibold mt-4 hover:bg-green-700">Add Lift Record</button>
                </div>

                <!-- Weekly Main Lift Summary -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Weekly Main Lift Progress</h2>
                    <p class="text-sm text-gray-500 mb-3">Showing highest recorded weight for main lifts this week (<span id="week-start">--</span> to <span id="week-end">--</span>).</p>
                    <div id="weekly-lifts-summary" class="space-y-3">
                        <p class="text-gray-500 italic">No main lifts recorded this week.</p>
                    </div>
                </div>
            </div>

            <!-- Progress Tab -->
            <div id="progress" class="tab-pane hidden">
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Historical Progress</h2>
                    <p class="text-gray-600 mb-4">Select a view to track your goals over time.</p>

                    <div class="flex space-x-4 mb-6">
                        <button class="flex-1 p-2 bg-blue-100 text-blue-700 rounded-lg font-semibold hover:bg-blue-200" onclick="renderProgress('weekly')">Weekly Macro/Lift Progress</button>
                        <button class="flex-1 p-2 bg-blue-100 text-blue-700 rounded-lg font-semibold hover:bg-blue-200" onclick="renderProgress('monthly')">Monthly Macro/Lift Progress</button>
                    </div>

                    <div id="progress-content" class="min-h-[200px] bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-500 italic text-center pt-8">Select a progress view above to load historical data.</p>
                        <!-- Progress charts/lists will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Goals Tab -->
            <div id="goals" class="tab-pane hidden">
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Set Your Goals</h2>
                    <p class="text-gray-600 mb-4">Define your daily targets for better tracking.</p>

                    <div class="space-y-4">
                        <div>
                            <label for="goal-cal" class="block text-sm font-medium text-gray-700">Daily Calorie Goal (kcal)</label>
                            <input type="number" id="goal-cal" placeholder="e.g., 2500" class="w-full p-2 border rounded-lg mt-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="goal-prot" class="block text-sm font-medium text-gray-700">Daily Protein Goal (g)</label>
                            <input type="number" id="goal-prot" placeholder="e.g., 180" class="w-full p-2 border rounded-lg mt-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button onclick="saveGoals()" class="w-full bg-blue-600 text-white p-3 rounded-xl font-semibold hover:bg-blue-700">Save Goals</button>
                    </div>

                    <div id="goal-save-message" class="mt-4 text-center text-sm text-green-600 hidden">Goals saved successfully!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Notification Modal (Floating Message Box) -->
    <div id="global-notification" class="fixed bottom-4 right-4 p-3 rounded-xl shadow-2xl text-white z-50 transition-transform transform translate-y-full opacity-0"></div>

</body>
</html>